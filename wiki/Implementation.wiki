#summary How to use jSCEP in your own application
#labels Phase-Implementation,Featured

<wiki:toc/>

= Introduction =

This page discusses how to use jSCEP in your own application.  For full usage information, you are recommended to download and read the [http://code.google.com/p/jscep/downloads/list?q=label:Featured%20type=Docs current javadoc package].

= Building a Requester =

It is possible to build a SCEP client with a variety of inputs.  However, as a minimum, each client must be able to locate the SCEP server:

{{{
URL url = new URL("http://www.example.org/scep/pkiclient.exe");
Requester.Builder builder = new Requester.Builder(url);
}}}

== Identifying the CA ==

Next, you must provide a way for the SCEP client to validate the CA.  This is done by providing the CA certificate:

{{{
X509Certificate ca = getCaCertificate();
builder.caCertificate(ca);
}}}

or by providing the digest of the certificate:

{{{
byte[] digest = getCaDigest();
builder.caDigest(digest);
}}}

If the digest isn't an `MD5` hash, you must specify the algorithm you've used, which must be one of `MD5`, `SHA-1`, `SHA-256` or `SHA-512`:

{{{
builder.digestAlgorithm("SHA-1");
}}}

If you provide a CA certificate and a digest algorithm, the SCEP client will use the algorithm you have requested when it does its own internal calculations.

== Specifying the Certification Entity ==

Next, you have to provide a certification entity.  What you provide is usually dictated by the operation you're performing.  If you're doing an initial enrollment, you'll usually provide a X.500 subject:

{{{
X500Principal subject = getSubject();
builder.subject(subject);
}}}

Alternatively, if you're renewing an existing certificate, you'll need to provide both the existing certificate and the RSA key pair associated with it.

{{{
X509Certificate identity = getCurrentCertificate();
KeyPair keyPair = getKeyPair();
builder.identity(identity).keyPair(keyPair);
}}}

In the case of an initial enrollment, you can provide your own self-signed certificate and generated key pair if you prefer.  If you don't, jSCEP will generate a certificate from the provided X.500 subject and create a new RSA key pair, which you can retrieve later.

== CA Identification ==

If your SCEP server provides multiple CA certificates, you might need to provide a ca identifier, e.g.

{{{
String caId = "myCA";
builder.caId(caId);
}}}

== Proxy Server ==

If you need to go through a proxy server to make HTTP requests, you will need to tell jSCEP the location of your proxy:

{{{
Proxy proxy = getProxy();
builder.proxy(proxy);
}}}

If you don't provide a proxy, jSCEP will default to using Proxy.NO_PROXY.

= Simple Example =

This example shows a simple automatic enrollment.

{{{
// Create the subject to be enrolled
X500Principal subject = new X500Principal("CN=jscep.googlecode.com,O=Google Inc,L=Mountain View,ST=California,C=US");
// Locate the SCEP server
URL url = new URL("http://www.example.org/scep/");

// Create a new client.  We'll use a generated key pair
Requester client = new Requester.Builder(url)
                                .subject(subject)
                                .build();
// Send the enrollment request using our secret password
EnrollmentResult result = client.enroll("password".toCharArray()); 
// Automatic enrollments will NEVER be pending
if (result.isPending() == false) {
    // Get the list of certificates from the result.
    List<X509Certificate> certs = result.getCertificates();
    // Get the generated key pair.
    KeyPair pair = client.getKeyPair();
}
}}}

== Renewing an Existing Certificate ==

If the CA supports renewal, we can renew an existing certificate.  This example assumes automatic enrollment.

{{{
// Locate the existing certificate
X509Certificate identity = ...;
// ...and the key pair
KeyPair keyPair = ...;
// Locate the SCEP server
URL url = new URL("http://www.example.org/scep/");

// Create our new client
Requester client = new Requester.Builder(url)
                                .identity(identity)
                                .keyPair(keyPair)
                                .build();
// Send the enrollment request using our secret password
EnrollmentResult result = client.enroll("password".toCharArray()); 
// Again, automatic enrollment is NEVER pending
if (result.isPending() == false) {
    // Retrieve the list of certificates
    List<X509Certificate> certs = result.getCertificates();
    // Replace the identity certificate.
    identity = certs.get(0);
}
}}}

== Pending Response ==

It is valid for the CA to have a manual policy, which might leave the request in a pending state.  jSCEP allows you to schedule the retry for later by providing a callable task.

{{{
// Create the subject to be enrolled
X500Principal subject = new X500Principal("CN=jscep.googlecode.com,O=Google Inc,L=Mountain View,ST=California,C=US");
// Locate the SCEP server
URL url = new URL("http://www.example.org/scep/");

// Create a new client.  We'll use a generated key pair
Requester client = new Requester.Builder(url)
                                .subject(subject)
                                .build();
// Send the enrollment request using our secret password
EnrollmentResult result = client.enroll("password".toCharArray());
// We fully expect our response to be pending...
ScheduledExecutorService exec = new ScheduledThreadPoolExecutor(1);
TimeUnit unit = TimeUnit.HOURS;
long wait = 2;
while (response.isPending()) {
    // Our CA guarantees a SLA of 2 hours for issuing new certificates, so come back then.
    ScheduledFuture<EnrollmentResponse> future = exec.schedule(result.getTask(), wait, unit);
    // Block this thread until it returns.  There are plenty of other things you can do here, obviously, depending on the responsibilities of this thread.
    response = future.get(wait, unit);
    // These steps can be repeated as many times as the result is pending, so you can implement a "backing-off" 
    // strategy by doubling your wait period. Next time we'll wait four hours, then eight, etc.
    wait *= 2;
}
}}}